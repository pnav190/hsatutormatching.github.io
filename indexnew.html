<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HSA Tutoring | Tutor Matching</title>
  <link rel="icon" href="https://upload.wikimedia.org/wikipedia/commons/4/4a/Harvard_shield_wreath.svg">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-crimson: #A51C30;
      --primary-crimson-variant: #7B1422;
      --accent-gold: #FFD700;
      --neutral-dark: #2C3E50;
      --neutral-dark-gray: #34495E;
      --neutral-medium-gray: #7F8C8D;
      --neutral-light-gray: #BDC3C7;
      --neutral-off-white: #F8F9FA;
      --neutral-white: #FFFFFF;
      --background-primary: linear-gradient(135deg, #FDF5F6 0%, #F8F9FA 100%);
      --background-secondary: #FFFFFF;
      --font-primary: 'Montserrat', system-ui, -apple-system, 'Segoe UI', Roboto, Arial, sans-serif;
      --font-fallback: Arial, sans-serif;
      --spacing-xs: 0.25rem;
      --spacing-sm: 0.5rem;
      --spacing-md: 1rem;
      --spacing-lg: 1.5rem;
      --spacing-xl: 2rem;
      --spacing-2xl: 3rem;
      --spacing-3xl: 4rem;
      --spacing-4xl: 6rem;
      --shadow-subtle: 0 2px 8px rgba(0, 0, 0, 0.06);
      --shadow-medium: 0 4px 20px rgba(0, 0, 0, 0.08);
      --shadow-strong: 0 8px 30px rgba(0, 0, 0, 0.12);
      --radius-small: 0.375rem;
      --radius-medium: 0.5rem;
      --radius-large: 1rem;
      --radius-circular: 50%;
    }
    html, body {
      height: 100%;
    }
    body {
      font-family: var(--font-primary);
      background: var(--background-primary);
      color: var(--neutral-dark);
      line-height: 1.6;
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
    }
    body::before {
      content: '';
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      z-index: 0;
      background: url('https://upload.wikimedia.org/wikipedia/commons/4/4a/Harvard_shield_wreath.svg') repeat 0 0/200px 200px, var(--background-primary);
      opacity: 0.025;
      pointer-events: none;
    }
    .main-container {
      padding: 0.5rem 0.5rem;
      gap: 0.5rem;
      max-width: 700px;
      margin: 0 auto;
    }
    .hero-section {
      margin-bottom: 0.5rem;
      padding-top: 0.5rem;
      text-align: center;
      position: relative;
      z-index: 1;
    }
    .hero-title {
      font-size: clamp(2rem, 4vw, 2.5rem);
      font-weight: 800;
      color: var(--primary-crimson);
      margin-bottom: 0.3rem;
      text-shadow: 0 2px 8px rgba(165,28,48,0.06);
    }
    .hero-subtitle {
      font-size: clamp(1rem, 2vw, 1.2rem);
      color: var(--neutral-dark-gray);
      font-weight: 500;
      margin-bottom: 0.3rem;
    }
    .nav-tabs {
      display: flex;
      gap: var(--spacing-md);
      list-style: none;
      justify-content: center;
      margin: 0.5rem 0 0.5rem 0;
      padding: 0;
    }
    .nav-tab {
      position: relative;
    }
    .nav-tab button {
      background: none;
      border: none;
      font-size: 1rem;
      font-weight: 500;
      color: var(--neutral-medium-gray);
      cursor: pointer;
      padding: var(--spacing-xs) var(--spacing-md);
      border-radius: var(--radius-small);
      transition: all 0.2s;
      outline: none;
    }
    .nav-tab button:hover, .nav-tab button:focus {
      color: var(--primary-crimson);
      background: var(--neutral-off-white);
      box-shadow: 0 2px 8px rgba(165,28,48,0.08);
      transform: translateY(-2px) scale(1.04);
    }
    .nav-tab button.active {
      color: var(--primary-crimson);
      background: var(--neutral-off-white);
      font-weight: 700;
    }
    .form-container {
      background: var(--background-secondary);
      border-radius: var(--radius-large);
      box-shadow: var(--shadow-medium);
      padding: 0.7rem 0.7rem 1rem 0.7rem;
      width: 100%;
      max-width: 500px;
      min-width: 0;
      min-height: 0;
      margin: 0 auto;
      transition: transform 0.3s, box-shadow 0.3s;
      border: 1.5px solid var(--neutral-light-gray);
      position: relative;
      overflow: visible;
    }
    .form-title {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--primary-crimson);
      margin-top: 0.2rem;
      margin-bottom: 0.7rem;
      text-align: center;
      letter-spacing: -0.01em;
    }
    .form-group {
      margin-bottom: 0.7rem;
      position: relative;
    }
    .form-label {
      font-weight: 600;
      color: var(--neutral-dark);
      display: block;
      margin-bottom: var(--spacing-xs);
      font-size: 1rem;
    }
    .form-input, .form-select, .form-textarea {
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
      min-height: 2.2em;
      text-align: left;
      border: 1.5px solid var(--neutral-light-gray);
      border-radius: var(--radius-medium);
      font-size: 1rem;
      font-family: var(--font-primary);
      background: var(--neutral-off-white);
      color: var(--neutral-dark);
      transition: all 0.2s;
      box-shadow: 0 1px 4px rgba(44,62,80,0.03);
      outline: none;
      display: block;
      padding-left: 1em;
    }
    .form-input:focus, .form-select:focus, .form-textarea:focus {
      border-color: var(--primary-crimson);
      box-shadow: 0 0 0 3px rgba(165, 28, 48, 0.12);
    }
    .form-input::placeholder, .form-textarea::placeholder {
      color: var(--neutral-medium-gray);
      opacity: 1;
      transition: color 0.2s;
    }
    .form-input:focus::placeholder, .form-textarea:focus::placeholder {
      color: var(--primary-crimson-variant);
      opacity: 0.7;
    }
    .submit-btn {
      background: linear-gradient(90deg, var(--primary-crimson), var(--primary-crimson-variant));
      color: var(--neutral-white);
      border: none;
      border-radius: var(--radius-medium);
      padding: 0.5rem 1rem;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      width: 100%;
      transition: all 0.2s;
      margin-top: 0.3rem;
      box-shadow: 0 2px 8px rgba(165,28,48,0.08);
      letter-spacing: 0.01em;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }
    .submit-btn:hover, .submit-btn:focus {
      background: linear-gradient(90deg, var(--primary-crimson-variant), var(--primary-crimson));
      transform: translateY(-2px) scale(1.03);
      box-shadow: 0 4px 16px rgba(165, 28, 48, 0.18);
    }
    .submit-btn:active {
      transform: translateY(0) scale(0.98);
    }
    .results-section {
      margin-top: 0.5rem;
      z-index: 1;
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      width: 100%;
      margin-left: 0;
      margin-right: 0;
    }
    .results-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--primary-crimson);
      margin-bottom: 0.5rem;
      text-align: center;
    }
    .tutor-grid {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin-top: 0.5rem;
      width: 100%;
      margin-left: 0;
      margin-right: 0;
    }
    .tutor-card {
      width: 90%;
      max-width: 90%;
      margin: 0.3rem auto;
      overflow-wrap: break-word;
      background: var(--background-secondary);
      border-radius: var(--radius-large);
      box-shadow: var(--shadow-medium);
      padding: 0.7rem;
      transition: transform 0.3s, box-shadow 0.3s;
      border: 1.5px solid var(--neutral-light-gray);
      position: relative;
      overflow: visible;
    }
    .tutor-card:hover {
      transform: translateY(-4px) scale(1.01);
      box-shadow: var(--shadow-strong);
    }
    .tutor-name {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--primary-crimson);
      margin-bottom: var(--spacing-xs);
      text-align: left;
    }
    .tutor-detail {
      font-size: 0.9rem;
      color: var(--neutral-dark-gray);
      margin-bottom: var(--spacing-xs);
      text-align: left;
    }
    .tutor-detail strong {
      color: var(--neutral-dark);
    }
    .tutor-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    .tutor-header:hover {
      opacity: 0.8;
    }
    .expand-arrow {
      font-size: 1.2rem;
      color: var(--primary-crimson);
      transition: transform 0.3s;
      cursor: pointer;
      padding: var(--spacing-xs);
      border-radius: var(--radius-small);
    }
    .expand-arrow:hover {
      background: var(--neutral-off-white);
    }
    .expand-arrow.expanded {
      transform: rotate(180deg);
    }
    .tutor-bio {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s, padding 0.3s;
      background: var(--neutral-off-white);
      border-radius: var(--radius-medium);
      margin-top: var(--spacing-xs);
    }
    .tutor-bio.expanded {
      max-height: 400px;
      padding: var(--spacing-sm);
      margin-top: var(--spacing-sm);
    }
    .tutor-bio-content {
      max-height: 350px;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--primary-crimson) var(--neutral-light-gray);
    }
    .tutor-bio-content::-webkit-scrollbar {
      width: 8px;
    }
    .tutor-bio-content::-webkit-scrollbar-track {
      background: var(--neutral-light-gray);
      border-radius: 4px;
    }
    .tutor-bio-content::-webkit-scrollbar-thumb {
      background: var(--primary-crimson);
      border-radius: 4px;
      transition: background 0.2s;
    }
    .tutor-bio-content::-webkit-scrollbar-thumb:hover {
      background: var(--primary-crimson-variant);
    }
    .tutor-bio-text {
      font-size: 0.9rem;
      line-height: 1.5;
      color: var(--neutral-dark-gray);
      padding-right: var(--spacing-sm);
      overflow-wrap: break-word;
    }
    .match-highlight {
      background: rgba(165, 28, 48, 0.1);
      color: var(--primary-crimson);
      font-weight: 600;
      padding: 0 2px;
      border-radius: 2px;
    }
    .no-results {
      text-align: center;
      color: var(--neutral-medium-gray);
      font-weight: 500;
      padding: var(--spacing-lg);
      background: var(--neutral-off-white);
      border-radius: var(--radius-large);
    }
    .pagination-container {
      margin-top: 0.5rem;
      text-align: center;
      padding: 0.5rem;
      background: var(--neutral-off-white);
      border-radius: var(--radius-large);
      border: 1px solid var(--neutral-light-gray);
    }
    .pagination-text {
      font-size: 0.9rem;
      color: var(--neutral-dark-gray);
      margin-bottom: var(--spacing-xs);
      font-weight: 500;
    }
    .load-more-btn {
      background: linear-gradient(90deg, var(--primary-crimson), var(--primary-crimson-variant));
      color: var(--neutral-white);
      border: none;
      border-radius: var(--radius-medium);
      padding: var(--spacing-md) var(--spacing-xl);
      font-size: 1rem;
      font-weight: 600;
      font-family: var(--font-primary);
      cursor: pointer;
      transition: all 0.2s;
      min-width: 200px;
      box-shadow: 0 2px 8px rgba(165,28,48,0.08);
    }
    .load-more-btn:hover, .load-more-btn:focus {
      background: linear-gradient(90deg, var(--primary-crimson-variant), var(--primary-crimson));
      transform: translateY(-2px) scale(1.03);
      box-shadow: 0 4px 16px rgba(165, 28, 48, 0.18);
    }
    .load-more-btn:active {
      transform: translateY(0) scale(0.98);
    }
    .tutorocean-info-box {
      background: var(--neutral-off-white);
      border: 1.5px solid var(--neutral-light-gray);
      border-radius: var(--radius-large);
      box-shadow: var(--shadow-subtle);
      max-width: 500px;
      margin: 0.5rem auto;
      padding: 0.7rem 0.5rem;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: var(--spacing-xs);
    }
    .tutorocean-info-text {
      font-size: 1.05rem;
      color: var(--neutral-dark-gray);
      font-weight: 500;
      margin-bottom: var(--spacing-xs);
    }
    .tutorocean-link {
      font-size: 1rem;
      color: var(--primary-crimson);
      font-weight: 700;
      text-decoration: underline;
      transition: color 0.2s;
    }
    .tutorocean-link:hover {
      color: var(--primary-crimson-variant);
    }
    .booking-button {
      background: linear-gradient(90deg, var(--primary-crimson), var(--primary-crimson-variant));
      color: var(--neutral-white);
      border: none;
      border-radius: var(--radius-medium);
      padding: 0.4rem 0.8rem;
      font-size: 0.85rem;
      font-weight: 600;
      font-family: var(--font-primary);
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(165,28,48,0.08);
      display: none;
      margin-left: auto;
      white-space: nowrap;
    }
    .booking-button:hover, .booking-button:focus {
      background: linear-gradient(90deg, var(--primary-crimson-variant), var(--primary-crimson));
      transform: translateY(-1px) scale(1.02);
      box-shadow: 0 4px 12px rgba(165, 28, 48, 0.15);
    }
    .booking-button:active {
      transform: translateY(0) scale(0.98);
    }
    .booking-button.visible {
      display: block;
    }
    .tutor-details-container {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: var(--spacing-sm);
    }
    .tutor-details-left {
      flex: 1;
    }
    .tutor-details-right {
      flex-shrink: 0;
    }
    .form-textarea {
      min-height: 120px;
      padding-top: 1em;
      padding-bottom: 1em;
      resize: vertical;
    }
    @media (max-width: 600px) {
      .main-container {
        padding: 0.2rem 0.1rem;
      }
      .form-container {
        max-width: 98vw;
        padding: 0.5rem 0.2rem;
      }
    }
  </style>
</head>
<body>
  <main class="main-container">
    <section class="hero-section">
      <ul class="nav-tabs">
        <li class="nav-tab">
          <button class="nav-btn active" data-section="college">College Counseling</button>
        </li>
        <li class="nav-tab">
          <button class="nav-btn" data-section="satact">SAT/ACT</button>
        </li>
        <li class="nav-tab">
          <button class="nav-btn" data-section="academics">General Academics</button>
        </li>
      </ul>
    </section>
    <section id="dynamic-form-section" class="form-container">
      <!-- The form content will be injected here by JavaScript -->
    </section>
  </main>
  <script>
    // Fetch tutor data from Sheet.best API (replace with your actual API URL)
    let tutors = [];
    fetch('https://api.sheetbest.com/sheets/b1af17d0-1d9e-4e3e-ada5-8a58e44eab5f')
      .then(response => response.json())
      .then(data => {
        tutors = data
          .filter(tutor => tutor['Active?'] && tutor['Active?'].toLowerCase() === 'yes')
          .map(tutor => {
            // Attempt to extract subjects from bio if not present
            const bio = tutor['Please submit your bio following the example structure below:Class year, Hometown, Relevant Test Scores, Major you applied as in High School, your high school activities, your expertise/specialty, and your current activities/future endeavors. "Eddie (class of 2028) is from Whitehouse Station, New Jersey, but he went to a private boarding school in Massachusetts. He scored a 1570 on the SAT and his primary interests in high school surrounded psychology. He started his own magic performing organization during the COVID pandemic, he led his school\'s environmental club focused on addressing people\'s inaction towards climate change, and he did mental health advocacy work with Mental Health America while also working as a teen therapist online. Eddie specializes in college application strategy and essay writing and is passionate about making his students standout in the process. He also specializes in all levels of math.Eddie currently works as the Sales Manager for HSA Tutoring, and is looking to go into the online business/entrepreneurship space in the future."Please brag a LOT in these bios! Parents choose who they want to work with in large part from your biography, so make sure yours stands out. For example, if you are primarily a STEM tutor, make sure your bio revolves around that. If you would like to do college app/essay mentorship, make sure your bio has relevant info about your high school experiences. *You are also going to upload your biography into your Tutor Ocean profile, so please copy and paste your answer below into your Tutor Ocean Account after finishing this form.'] || '';
            const majorSheet = tutor['Major you applied as in High School'] || '';
            // List of common subjects/majors to look for
            const subjectKeywords = ['math', 'mathematics', 'biology', 'chemistry', 'physics', 'english', 'history', 'government', 'economics', 'computer science', 'statistics', 'psychology', 'neuroscience', 'writing', 'reading', 'environmental science', 'french', 'spanish', 'german', 'philosophy', 'engineering'];
            let foundSubjects = [];
            subjectKeywords.forEach(subj => {
              const regex = new RegExp(`\\b${subj}\\b`, 'i');
              if (regex.test(bio)) foundSubjects.push(subj.charAt(0).toUpperCase() + subj.slice(1));
            });
            // Remove duplicates
            foundSubjects = [...new Set(foundSubjects)];
            // Use major from sheet if present, otherwise use first found subject
            const major = majorSheet || (foundSubjects.length > 0 ? foundSubjects[0] : '');
            // Compose subjects as comma-separated string
            const subjects = foundSubjects.join(', ');
            return {
              name: tutor['Full Name'],
              grade: tutor['Graduating Year'],
              major,
              tests: tutor['Relevant Test Scores'],
              bio,
              subjects,
              // Add more mappings as needed
            };
          });
        // Now tutors will have the correct field names for your matching logic
        // Render the form and attach listeners only after tutors are loaded
        const dynamicFormSection = document.getElementById('dynamic-form-section');
        dynamicFormSection.innerHTML = formTemplates.college;
        attachFormListeners('college');
        const navButtons = document.querySelectorAll('.nav-btn');
        navButtons.forEach(button => {
          button.addEventListener('click', () => {
            navButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            const section = button.dataset.section;
            dynamicFormSection.innerHTML = formTemplates[section];
            attachFormListeners(section);
          });
        });
      });

    // Remove the initial rendering/attachment from outside the fetch
    // const dynamicFormSection = document.getElementById('dynamic-form-section');
    // dynamicFormSection.innerHTML = formTemplates.college;
    // attachFormListeners('college');
    // const navButtons = document.querySelectorAll('.nav-btn');
    // navButtons.forEach(button => {
    //   button.addEventListener('click', () => {
    //     navButtons.forEach(btn => btn.classList.remove('active'));
    //     button.classList.add('active');
    //     const section = button.dataset.section;
    //     dynamicFormSection.innerHTML = formTemplates[section];
    //     attachFormListeners(section);
    //   });
    // });

    // Add formTemplates for dynamic form rendering
    const formTemplates = {
      college: `
        <h2 class="form-title">College Counseling</h2>
        <form id="college-form">
          <div class="form-group">
            <label for="college-interests" class="form-label">Your Interests/Activities</label>
            <textarea id="college-interests" class="form-textarea" placeholder="Please list some of your activities and interests (e.g. Debate, Math, Music, Research) and a matching tutor will appear" required></textarea>
          </div>
          <button type="submit" class="submit-btn">Find College Counseling Tutors</button>
        </form>
        <div id="college-results" class="results-section"></div>
      `,
      satact: `
        <h2 class="form-title">SAT/ACT Preparation</h2>
        <form id="satact-form">
          <div class="form-group">
            <label for="test-type" class="form-label">Which test?</label>
            <select id="test-type" class="form-select" required>
              <option value="" disabled selected>Select test</option>
              <option value="SAT">SAT</option>
              <option value="ACT">ACT</option>
            </select>
          </div>
          <div class="form-group">
            <label for="desired-score" class="form-label">Desired Score</label>
            <input type="number" id="desired-score" class="form-input" min="400" max="1600" step="10" placeholder="e.g. 1500" required />
          </div>
          <button type="submit" class="submit-btn">Find SAT/ACT Tutors</button>
        </form>
        <div id="satact-results" class="results-section"></div>
      `,
      academics: `
        <h2 class="form-title">General Academics</h2>
        <form id="academics-form">
          <div class="form-group">
            <label for="academics-subjects" class="form-label">Subjects you need help with</label>
            <textarea id="academics-subjects" class="form-textarea" placeholder="Please list the subjects you need help in (e.g. Math, Chemistry, History) and tutors in those fields of expertise will appear" required></textarea>
          </div>
          <button type="submit" class="submit-btn">Find Academic Tutors</button>
        </form>
        <div id="academics-results" class="results-section"></div>
      `
    };

    // Utility: extract keywords from a string
    function extractKeywords(str) {
      return str
        .toLowerCase()
        .replace(/-/g, ' ')
        .replace(/[^a-z0-9\s]/g, '')
        .split(/\s+/)
        .filter(Boolean);
    }

    function hasWordMatch(searchTerm, text) {
      if (!searchTerm || !text) return false;
      const lowerText = text.toLowerCase();
      const lowerSearchTerm = searchTerm.toLowerCase();
      const wordBoundaryRegex = new RegExp(`\\b${lowerSearchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b`, 'i');
      if (wordBoundaryRegex.test(lowerText)) return true;
      const variations = getWordVariations(lowerSearchTerm);
      for (const variation of variations) {
        const variationRegex = new RegExp(`\\b${variation.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b`, 'i');
        if (variationRegex.test(lowerText)) return true;
      }
      return false;
    }
    function areTermsEquivalent(term1, term2) {
      const lowerTerm1 = term1.toLowerCase();
      const lowerTerm2 = term2.toLowerCase();
      if (lowerTerm1 === lowerTerm2) return true;
      const mathTerms = ['math', 'mathematics', 'mathematical'];
      if (mathTerms.includes(lowerTerm1) && mathTerms.includes(lowerTerm2)) return true;
      return false;
    }
    function getWordVariations(word) {
      const variations = [];
      if (word.endsWith('y')) {
        variations.push(word.slice(0, -1) + 'ies');
      } else if (word.endsWith('s') || word.endsWith('sh') || word.endsWith('ch') || word.endsWith('x') || word.endsWith('z')) {
        variations.push(word + 'es');
      } else {
        variations.push(word + 's');
      }
      if (word.endsWith('e')) {
        variations.push(word + 'd');
        variations.push(word + 'ing');
      } else if (word.endsWith('y')) {
        variations.push(word.slice(0, -1) + 'ied');
        variations.push(word.slice(0, -1) + 'ying');
      } else {
        variations.push(word + 'ed');
        variations.push(word + 'ing');
      }
      if (word.endsWith('tion')) {
        variations.push(word.replace(/tion$/, 'te'));
        variations.push(word.replace(/tion$/, 'ting'));
      }
      if (word === 'math') {
        variations.push('mathematics');
        variations.push('mathematical');
      } else if (word === 'mathematics') {
        variations.push('math');
        variations.push('mathematical');
      } else if (word === 'mathematical') {
        variations.push('math');
        variations.push('mathematics');
      }
      return variations;
    }

    function matchTutors(formData) {
      let matches = [];
      if (formData.type === 'college') {
        const interests = extractKeywords(formData.interests);
        matches = tutors.map(tutor => {
          let score = 0;
          const matchedKeywords = [];
          const majorMatches = [];
          for (const interest of interests) {
            if (hasWordMatch(interest, tutor.major)) {
              score += 3;
              majorMatches.push(interest);
              if (!matchedKeywords.some(keyword => areTermsEquivalent(keyword, interest))) {
                matchedKeywords.push(interest);
              }
            } else if (hasWordMatch(interest, tutor.college || '')) {
              score += 2;
              if (!matchedKeywords.some(keyword => areTermsEquivalent(keyword, interest))) {
                matchedKeywords.push(interest);
              }
            } else if (hasWordMatch(interest, tutor.bio || '')) {
              score += 1;
              if (!matchedKeywords.some(keyword => areTermsEquivalent(keyword, interest))) {
                matchedKeywords.push(interest);
              }
            }
          }
          const uniqueMatches = matchedKeywords.length;
          const breadthBonus = uniqueMatches * 1.0;
          score += breadthBonus;
          return { tutor, score, matchedKeywords, searchTerms: interests, majorMatches };
        }).filter(m => m.score > 0).sort((a, b) => b.score - a.score);
      } else if (formData.type === 'satact') {
        matches = tutors.map(tutor => {
          const testExp = tutor.tests && tutor.tests.toUpperCase().includes(formData.testType);
          const standardizedExp = tutor.standardized && tutor.standardized.toUpperCase().includes(formData.testType);
          if (!testExp && !standardizedExp) return { tutor, score: 0 };
          let scoreMatch = null;
          if (formData.testType === 'SAT') {
            scoreMatch = tutor.tests && tutor.tests.match(/(\d{3,4})/g);
          } else if (formData.testType === 'ACT') {
            scoreMatch = tutor.tests && tutor.tests.match(/(\d{1,2})/g);
          }
          if (scoreMatch) {
            const scores = scoreMatch.map(Number).filter(s => {
              if (formData.testType === 'SAT') return s >= 400 && s <= 1600;
              if (formData.testType === 'ACT') return s >= 1 && s <= 36;
              return false;
            });
            if (scores.length === 0) return { tutor, score: 0 };
            
            const bestScore = Math.max(...scores);
            const hasQualifyingScore = bestScore >= formData.score;
            
            if (hasQualifyingScore) {
              // Tutor has achieved the desired score or higher
              const scoreDifference = bestScore - formData.score;
              return { tutor, score: 1 + (scoreDifference / 100) };
            } else {
              // Tutor hasn't achieved the desired score, but we'll still include them
              // with a lower score based on how close they are to the desired score
              const scoreDifference = formData.score - bestScore;
              const proximityScore = Math.max(0.1, 1 - (scoreDifference / 200)); // Closer scores get higher ratings
              return { tutor, score: proximityScore, bestScore };
            }
          }
          return { tutor, score: 0.5 };
        }).filter(m => m.score > 0).sort((a, b) => b.score - a.score);
      } else if (formData.type === 'academics') {
        const subjects = extractKeywords(formData.subjects);
        matches = tutors.map(tutor => {
          let score = 0;
          const matchedKeywords = [];
          for (const subject of subjects) {
            if (hasWordMatch(subject, tutor.subjects || '')) {
              score += 2;
              if (!matchedKeywords.some(keyword => areTermsEquivalent(keyword, subject))) {
                matchedKeywords.push(subject);
              }
            } else if (hasWordMatch(subject, tutor.major)) {
              score += 1;
              if (!matchedKeywords.some(keyword => areTermsEquivalent(keyword, subject))) {
                matchedKeywords.push(subject);
              }
            }
          }
          return { tutor, score, matchedKeywords, searchTerms: subjects, subjectsList: tutor.subjects || 'N/A' };
        }).filter(m => m.score > 0).sort((a, b) => b.score - a.score);
      }
      return matches;
    }

    function renderResults(tutors, resultsId) {
      const resultsDiv = document.getElementById(resultsId);
      resultsDiv.innerHTML = '';
      if (!tutors.length) {
        resultsDiv.innerHTML = '<div class="no-results">No matching tutors found. Try broadening your input!</div>';
        return;
      }
      const resultsTitle = document.createElement('h3');
      resultsTitle.className = 'results-title';
      resultsTitle.textContent = `Found ${tutors.length} matching tutor${tutors.length > 1 ? 's' : ''}`;
      resultsDiv.appendChild(resultsTitle);
      resultsDiv.setAttribute('data-all-tutors', JSON.stringify(tutors));
      const tutorsToShow = tutors.slice(0, 3);
      renderTutorGrid(tutorsToShow, resultsDiv, resultsId);
      if (tutors.length > 3) {
        addPagination(resultsDiv, tutors.length, resultsId, 3);
      }
    }
    function renderTutorGrid(tutorsToShow, resultsDiv, resultsId) {
      const existingGrid = resultsDiv.querySelector('.tutor-grid');
      if (existingGrid) existingGrid.remove();
      const tutorGrid = document.createElement('div');
      tutorGrid.className = 'tutor-grid';
      tutorsToShow.forEach((match, index) => {
        const tutor = match.tutor;
        const tutorCard = document.createElement('div');
        tutorCard.className = 'tutor-card';
        const tutorHeader = document.createElement('div');
        tutorHeader.className = 'tutor-header';
        tutorHeader.innerHTML = `
          <div class="tutor-name">${tutor.name}</div>
          <div class="expand-arrow">▼</div>
        `;
        const tutorDetails = document.createElement('div');
        tutorDetails.className = 'tutor-details-container';
        
        const detailsLeft = document.createElement('div');
        detailsLeft.className = 'tutor-details-left';
        let detailsHTML = `
          <div class="tutor-detail"><strong>Graduation Year:</strong> ${tutor.grade}</div>
          <div class="tutor-detail"><strong>Major(s):</strong> ${tutor.major}</div>
          <div class="tutor-detail"><strong>SAT/ACT:</strong> ${tutor.tests || 'N/A'}</div>
        `;
        if (resultsId === 'academics-results' && match.subjectsList) {
          detailsHTML += `<div class="tutor-detail"><strong>Subjects:</strong> ${match.subjectsList}</div>`;
        }
        detailsLeft.innerHTML = detailsHTML;
        
        const detailsRight = document.createElement('div');
        detailsRight.className = 'tutor-details-right';
        
        const bookingButton = document.createElement('button');
        bookingButton.className = 'booking-button';
        bookingButton.textContent = 'Book Now';
        bookingButton.addEventListener('click', (e) => {
          e.stopPropagation();
          if (tutor.tutorocean) {
            window.open(tutor.tutorocean, '_blank');
          }
        });
        
        detailsRight.appendChild(bookingButton);
        tutorDetails.appendChild(detailsLeft);
        tutorDetails.appendChild(detailsRight);
        const tutorBio = document.createElement('div');
        tutorBio.className = 'tutor-bio';
        let bioText = tutor.bio || 'No bio available.';
        if (match.searchTerms && match.searchTerms.length > 0) {
          const searchTerms = match.searchTerms || [];
          const matchedKeywords = match.matchedKeywords || [];
          const keywordsToHighlight = [...new Set([...searchTerms, ...matchedKeywords])];
          const allHighlightTerms = new Set();
          keywordsToHighlight.forEach(keyword => {
            allHighlightTerms.add(keyword);
            const variations = getWordVariations(keyword);
            variations.forEach(variation => allHighlightTerms.add(variation));
          });
          const highlightPatterns = Array.from(allHighlightTerms).map(term => {
            const escapedTerm = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            return new RegExp(`\\b${escapedTerm}\\b`, 'gi');
          });
          highlightPatterns.forEach(pattern => {
            bioText = bioText.replace(pattern, '<span class="match-highlight">$&</span>');
          });
        }
        tutorBio.innerHTML = `
          <div class="tutor-bio-content">
            <div class="tutor-bio-text">${bioText}</div>
          </div>
        `;
        tutorCard.appendChild(tutorHeader);
        tutorCard.appendChild(tutorDetails);
        tutorCard.appendChild(tutorBio);
        tutorHeader.addEventListener('click', () => {
          const arrow = tutorHeader.querySelector('.expand-arrow');
          const bio = tutorCard.querySelector('.tutor-bio');
          const bookingButton = tutorCard.querySelector('.booking-button');
          if (bio.classList.contains('expanded')) {
            bio.classList.remove('expanded');
            arrow.classList.remove('expanded');
            bookingButton.classList.remove('visible');
          } else {
            bio.classList.add('expanded');
            arrow.classList.add('expanded');
            bookingButton.classList.add('visible');
          }
        });
        const bioContent = tutorCard.querySelector('.tutor-bio-content');
        if (bioContent) {
          let isScrolling = false;
          let scrollVelocity = 0;
          let lastScrollTop = 0;
          let animationFrame;
          bioContent.addEventListener('scroll', () => {
            if (!isScrolling) {
              isScrolling = true;
            }
            const currentScrollTop = bioContent.scrollTop;
            scrollVelocity = currentScrollTop - lastScrollTop;
            lastScrollTop = currentScrollTop;
            if (animationFrame) {
              cancelAnimationFrame(animationFrame);
            }
            const applyInertia = () => {
              if (Math.abs(scrollVelocity) > 0.1) {
                scrollVelocity *= 0.95;
                bioContent.scrollTop += scrollVelocity;
                animationFrame = requestAnimationFrame(applyInertia);
              } else {
                isScrolling = false;
                scrollVelocity = 0;
              }
            };
            setTimeout(() => {
              if (!isScrolling) {
                animationFrame = requestAnimationFrame(applyInertia);
              }
            }, 50);
          });
          bioContent.addEventListener('wheel', (e) => {
            e.preventDefault();
            const delta = e.deltaY;
            bioContent.scrollTop += delta * 0.5;
          }, { passive: false });
        }
        tutorGrid.appendChild(tutorCard);
      });
      resultsDiv.appendChild(tutorGrid);
    }
    function addPagination(resultsDiv, totalTutors, resultsId, pageSize = 3) {
      const existingPagination = resultsDiv.querySelector('.pagination-container');
      if (existingPagination) existingPagination.remove();
      const paginationContainer = document.createElement('div');
      paginationContainer.className = 'pagination-container';
      const paginationText = document.createElement('p');
      paginationText.className = 'pagination-text';
      paginationText.textContent = `Showing 1-${pageSize} of ${totalTutors} tutors`;
      const loadMoreButton = document.createElement('button');
      loadMoreButton.className = 'load-more-btn';
      loadMoreButton.textContent = 'View All Tutors';
      loadMoreButton.addEventListener('click', () => {
        window.open('https://hsatutoring.tutorocean.com/search/list?sortBy=recommended', '_blank');
      });
      paginationContainer.appendChild(paginationText);
      paginationContainer.appendChild(loadMoreButton);
      resultsDiv.appendChild(paginationContainer);
    }

    // Attach form listeners after rendering
    function attachFormListeners(section) {
      if (section === 'college') {
        document.getElementById('college-form').addEventListener('submit', function(e) {
          e.preventDefault();
          const interests = document.getElementById('college-interests').value.trim();
          if (!interests) {
            alert('Please enter your interests/activities.');
            return;
          }
          const formData = { type: 'college', interests };
          const results = matchTutors(formData);
          renderResults(results, 'college-results');
        });
      } else if (section === 'satact') {
        document.getElementById('satact-form').addEventListener('submit', function(e) {
          e.preventDefault();
          const testType = document.getElementById('test-type').value;
          const scoreInput = document.getElementById('desired-score').value;
          if (!testType) {
            alert('Please select a test type.');
            return;
          }
          const score = parseInt(scoreInput, 10);
          if (testType === 'SAT') {
            if (isNaN(score) || score < 400 || score > 1600) {
              alert('Please enter a valid SAT score between 400 and 1600.');
              return;
            }
          } else if (testType === 'ACT') {
            if (isNaN(score) || score < 1 || score > 36) {
              alert('Please enter a valid ACT score between 1 and 36.');
              return;
            }
          } else {
            alert('Invalid test type.');
            return;
          }
          const formData = { type: 'satact', testType, score };
          const results = matchTutors(formData);
          renderResults(results, 'satact-results');
        });
        const testTypeSelect = document.getElementById('test-type');
        const desiredScoreInput = document.getElementById('desired-score');
        if (testTypeSelect && desiredScoreInput) {
          testTypeSelect.addEventListener('change', function() {
            if (this.value === 'SAT') {
              desiredScoreInput.placeholder = 'e.g. 1500';
              desiredScoreInput.min = 400;
              desiredScoreInput.max = 1600;
              desiredScoreInput.step = 10;
            } else if (this.value === 'ACT') {
              desiredScoreInput.placeholder = 'e.g. 34';
              desiredScoreInput.min = 1;
              desiredScoreInput.max = 36;
              desiredScoreInput.step = 1;
            } else {
              desiredScoreInput.placeholder = '';
            }
          });
        }
      } else if (section === 'academics') {
        document.getElementById('academics-form').addEventListener('submit', function(e) {
          e.preventDefault();
          const subjects = document.getElementById('academics-subjects').value.trim();
          if (!subjects) {
            alert('Please enter the subjects you need help with.');
            return;
          }
          const formData = { type: 'academics', subjects };
          const results = matchTutors(formData);
          renderResults(results, 'academics-results');
        });
      }
    }
  </script>
</body>
</html> 